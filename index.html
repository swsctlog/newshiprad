<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора | CyberGuard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f0f2f5;
        }
        #login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #dashboard-screen {
            display: none; /* Скрыто по умолчанию */
        }
        .table-responsive {
            max-height: 70vh;
        }
        .table th {
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 1;
        }
    </style>
</head>
<body>

    <!-- Экран входа -->
    <div id="login-screen">
        <div class="col-md-4 col-lg-3">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h3 class="card-title text-center mb-4">Вход в панель</h3>
                    <form id="loginForm">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="login" placeholder="Логин" required>
                            <label for="login">Логин</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="password" class="form-control" id="password" placeholder="Пароль" required>
                            <label for="password">Пароль</label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2">Войти</button>
                        <div id="login-error" class="text-danger mt-2 text-center" style="display: none;">Неверный логин или пароль</div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Панель администратора (скрыта) -->
    <div id="dashboard-screen">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="#"><i class="bi bi-person-badge"></i> Панель администратора</a>
                <button id="logout-btn" class="btn btn-outline-light">Выйти <i class="bi bi-box-arrow-right"></i></button>
            </div>
        </nav>

        <div class="container mt-4">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-people-fill"></i> Логи посетителей</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" id="searchInput" class="form-control" placeholder="Поиск по IP, стране, городу или дате...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Время</th>
                                    <th>IP Адрес</th>
                                    <th>Страна</th>
                                    <th>Город</th>
                                    <th>Провайдер</th>
                                    <th>VPN/Прокси</th>
                                    <th>User Agent</th>
                                </tr>
                            </thead>
                            <tbody id="visitors-table-body">
                                <!-- Данные будут загружены сюда -->
                            </tbody>
                        </table>
                        <div id="loading-indicator" class="text-center p-4" style="display: none;">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase и Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const SUPABASE_URL = 'https://yqxbrbsxdkwcyafdkeld.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxeGJyYnN4ZGt3Y3lhZmRrZWxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwMTI3MTgsImV4cCI6MjA2NjU4ODcxOH0.i9h-YqUOYLLft5TFnU8UPYYXc6ixiHlIBVHuNTwgXfU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logout-btn');
        const visitorsTableBody = document.getElementById('visitors-table-body');
        const loadingIndicator = document.getElementById('loading-indicator');
        const searchInput = document.getElementById('searchInput');
        let allVisitors = []; // Для хранения всех данных для поиска

        // --- ЛОГИКА АУТЕНТИФИКАЦИИ ---
        
        // Проверка при загрузке страницы, залогинен ли пользователь
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('isLoggedIn') === 'true') {
                showDashboard();
            }
        });

        // Обработка формы входа
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const login = document.getElementById('login').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');

            const { data, error } = await supabaseClient
                .from('users')
                .select('id')
                .eq('login', login)
                .eq('password', password); // Опять же, небезопасно для продакшена!

            if (data && data.length > 0) {
                localStorage.setItem('isLoggedIn', 'true');
                showDashboard();
            } else {
                loginError.style.display = 'block';
            }
        });

        // Выход из системы
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('isLoggedIn');
            location.reload();
        });

        function showDashboard() {
            loginScreen.style.display = 'none';
            dashboardScreen.style.display = 'block';
            fetchVisitors();
        }

        // --- ЛОГИКА ОТОБРАЖЕНИЯ ДАННЫХ ---

        async function fetchVisitors() {
            loadingIndicator.style.display = 'block';
            visitorsTableBody.innerHTML = '';

            const { data, error } = await supabaseClient
                .from('visitors')
                .select('*')
                .order('created_at', { ascending: false });

            loadingIndicator.style.display = 'none';
            if (error) {
                console.error("Ошибка загрузки данных:", error);
                visitorsTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Не удалось загрузить данные.</td></tr>`;
                return;
            }
            
            allVisitors = data;
            renderTable(allVisitors);
        }
        
        function renderTable(visitors) {
            visitorsTableBody.innerHTML = '';
            if (visitors.length === 0) {
                visitorsTableBody.innerHTML = `<tr><td colspan="7" class="text-center">Нет данных для отображения.</td></tr>`;
                return;
            }
            
            visitors.forEach(visitor => {
                const tr = document.createElement('tr');
                const formattedDate = new Date(visitor.created_at).toLocaleString('ru-RU');
                
                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${visitor.ip_address || 'N/A'}</td>
                    <td>${visitor.country_name || 'N/A'}</td>
                    <td>${visitor.city_name || 'N/A'}</td>
                    <td>${visitor.isp || 'N/A'}</td>
                    <td>${visitor.is_proxy ? 'Да' : 'Нет'}</td>
                    <td><small>${visitor.user_agent || 'N/A'}</small></td>
                `;
                visitorsTableBody.appendChild(tr);
            });
        }

        // --- ЛОГИКА ПОИСКА ---
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredVisitors = allVisitors.filter(visitor => {
                const date = new Date(visitor.created_at).toLocaleString('ru-RU');
                return (
                    (visitor.ip_address && visitor.ip_address.toLowerCase().includes(searchTerm)) ||
                    (visitor.country_name && visitor.country_name.toLowerCase().includes(searchTerm)) ||
                    (visitor.city_name && visitor.city_name.toLowerCase().includes(searchTerm)) ||
                    (date && date.toLowerCase().includes(searchTerm))
                );
            });
            renderTable(filteredVisitors);
        });

    </script>
</body>
</html>
